#include <stdbool.h>
#include <stdint.h>
#include <string.h>
#include <math.h>
#include <stdio.h>
#include <errno.h>
#include <stdbool.h>
#include <stdint.h>
#include "nrf_delay.h"
#include "boards.h"
#include "nrf.h"
#include "nrf_drv_gpiote.h"
#include "nrfx_gpiote.h"
#include "app_error.h"
#include "BSP_UART.h"
#include "bsp.h"

#include "nrfx_twim.h"
#include "lsm6dsl_reg.h"
#include "nrf_drv_twi.h"
#include "arm_math.h"
#include "arm_const_structs.h"
#include "threshold_logic.h"
#include "filter_logic.h"
#include "calculation_features.h"
#include "linearSVC.h"

//typedef union{
//  int16_t i16bit[3];
//  uint8_t u8bit[6];
//} axis3bit16_t;
//
//typedef union{
//  int16_t i16bit;
//  uint8_t u8bit[2];
//} axis1bit16_t;
float32_t testInput[1024] = {   3.004333740598942315e-01,7.542823344034725874e-01,2.847016321200643851e-01,8.393830147122693930e-01,9.801402240499313967e-01,9.514982521197992149e-01,9.917377633514613544e-01,9.776649796103010770e-01,6.444904995887218435e-01,5.115828797394549321e-01,7.146026279119483959e-01,2.301558400326619847e-02,7.918770277998470331e-01,3.553877563927210215e-01,9.845855026695697898e-01,5.682283203013087647e-01,9.498742395631792901e-01,5.476443977390483830e-01,9.867982487931753477e-01,8.186587920650389982e-02,6.302663556685134116e-01,3.797534989632260771e-01,8.875609756075878432e-01,7.642484144547824210e-01,5.145230301259314798e-01,8.572391814969614332e-01,7.402887031750748914e-02,8.309779624464705972e-01,3.756509952999159685e-01,5.602502283568497887e-01,2.375060042183643194e-01,9.259401963678947078e-01,9.317162813006064637e-01,7.883849617880317462e-01,4.757477834332899391e-01,1.983490707146731147e-01,1.552589180707292238e-01,2.016528386043847654e-01,3.732723085778164585e-01,4.531448975082993380e-01,4.706180577623267913e-01,3.530721326524188797e-02,2.018411942916038537e-01,5.997218361420640909e-01,3.141457856809494187e-01,1.777422598247495600e-01,8.388879908954662845e-01,7.360272833660250758e-01,8.196943485781471583e-02,5.575344251343846702e-01,6.464180269828381231e-01,1.787688230858734961e-01,8.891039942737399837e-01,4.068047204126536975e-01,4.879752665059016170e-01,8.384813050239880994e-01,7.386311458338412628e-01,7.431907022843049493e-01,3.775039336015443281e-01,5.530584900640274082e-01,8.026879721110842247e-01,8.023675621290690119e-01,9.680404186545704670e-01,1.412440642298155025e-01,4.525404957234935299e-01,8.394410857435909978e-01,2.112466067295738492e-01,4.558281629000121571e-01,2.297433465629696858e-01,8.840055351607700729e-02,3.335723709372105938e-01,6.212381899742291935e-01,8.681107449482149407e-01,6.431558691958527696e-02,8.135916533305799225e-01,7.822918145356114739e-01,8.367787584133146161e-03,4.746461863607188691e-01,5.345042436772943217e-01,4.898887151247690586e-01,6.946069137697942208e-01,5.874412808438735922e-01,2.650806556106085621e-01,5.605855974779444528e-01,6.286165987634196872e-01,4.675211078381008578e-01,3.804652574391579334e-01,9.756034162826066058e-01,1.149918775068771160e-01,8.481198781885314064e-01,9.400109326642913654e-01,6.179433863883253553e-01,1.955679527889275793e-01,3.082666135900788973e-01,5.994671311559629512e-01,8.937925936318862341e-01,2.119380216859162447e-01,6.109625885073607376e-01,3.346807552818288345e-01,5.672819458549253069e-01,8.511242242825581839e-01,5.483279813378488798e-01,6.559913592007315941e-01,4.216875322476500987e-01,1.601334144758140843e-01,5.368171475656994263e-01,9.696487295685176644e-01,7.441941686784139254e-01,3.229625755264700082e-01,6.662727412306254093e-01,4.557704746094560777e-01,5.458316210297325943e-01,2.341097855052290955e-01,2.956668475561403664e-01,7.295015071984027877e-01,8.293081227309343495e-01,9.168610571946439469e-01,9.917264640184866309e-01,9.586511966401212170e-02,9.747364583540857330e-01,8.453922903753989804e-01,6.519593135928671845e-01,1.467267935154827896e-01,7.897906378839889552e-01,1.253328519282839171e-01,7.885093572873408396e-01,3.587039645538776522e-01,5.140362257454156314e-01,6.101704870075230769e-02,8.762350979067413670e-01,8.818232573577157174e-01,3.955357477440187841e-01,2.575245988433061406e-03,2.035222517039717571e-01,8.973708820288547328e-01,5.511953307541485048e-01,7.228981669446004066e-01,5.572106649998189720e-01,5.523451347280825541e-01,2.522078719256354296e-01,6.529067781694908312e-01,1.175502718115435385e-01,2.187678345680361680e-01,6.908266391734889655e-01,5.525587068228073884e-01,6.116600014207357328e-01,9.995231216611201175e-01,7.473193044795242157e-01,6.214772313323914110e-01,6.910570086743303975e-01,7.669963487356531440e-01,6.053589063225102151e-01,9.791874524212579312e-01,5.814645339105396493e-01,9.634682986462892451e-01,5.434874897078110223e-01,1.113871117362533747e-01,7.889981548399938038e-01,3.759491025087885463e-01,5.653808624863800869e-01,3.937465647360208765e-01,3.913355246843527313e-01,4.428804471792753272e-01,6.192023766725948120e-01,8.334180600527159033e-01,3.716850101353595948e-01,6.152474441129207605e-03,5.903952229536998386e-01,8.000375093487456235e-01,5.448352826211343425e-01,2.480103629826129197e-01,2.051181030768800539e-01,9.909881813943348661e-01,2.595714255620882316e-01,9.739579217161307145e-01,3.544750002418729506e-01,8.922682457384756294e-01,5.247204999725154639e-01,4.259893534927772230e-01,1.804427307942645387e-01,2.014428684177934636e-01,7.410809429729554587e-01,2.969340160358383551e-01,1.767268841469592511e-01,8.624919674344100340e-01,9.580788774023495380e-01,9.877120469855205087e-01,4.708725039831841430e-01,2.950716958464927320e-01,5.502996129708065398e-01,8.749732830488434754e-01,7.228846040358609670e-01,5.813953390120992770e-01,2.995162186093291989e-01,1.717820687716024031e-01,6.390428051002923215e-01,8.934477966456554343e-01,5.635250401408720133e-01,7.373275255379644344e-01,2.282793492479372466e-01,1.623299649674905254e-01,8.187991115688978416e-01,9.777277918948490409e-02,4.450537661525756361e-01,6.807212360232367532e-01,2.445907175621060414e-01,7.277606460782652942e-01,4.369498333531907086e-02,2.037008769641418526e-01,2.771057759899165918e-01,8.815137948216178465e-01,6.856085513080978355e-02,5.765278188826699068e-01,9.415840747995203319e-01,5.333941636381479556e-01,3.294327944213713000e-01,2.429149728557933319e-01,3.064101082289778510e-01,3.767172865051706676e-01,5.356576025047893319e-01,9.712652615689795210e-01,6.002339879430065306e-01,1.827496571540382364e-01,4.982060215626060717e-02,7.110940037499431376e-01,1.341986959757287545e-01,2.102950843648856427e-01,7.336863217738569531e-01,6.069608573352401892e-01,6.681712011874423318e-01,1.500408007920370768e-01,4.915300182587578615e-01,6.080097124214389748e-02,9.908885762688244281e-01,2.405941859881284284e-01,6.905189226591723628e-02,2.031383575906321459e-01,3.933756542958789515e-01,9.300722750938675842e-01,8.725901194808455275e-01,7.007318089068570455e-01,4.633555187098145067e-01,5.263724110424479186e-01,6.029130553992616548e-01,5.878200820694735595e-01,8.914747313631652403e-01,1.576041117494276778e-01,4.959370690887787703e-01,8.733581023096622653e-01,4.255723657419300254e-01,2.897446804853098801e-02,5.682533762666897026e-02,4.327648769270405760e-01,5.403705140067649459e-02,9.071318935919513438e-01,3.369546325471343140e-01,1.247584731128041913e-01,4.669817171626576835e-01,4.361815976643907966e-01,6.583431022745418471e-01,8.810150109152792286e-02,8.299202578547700826e-01,8.180899265999741488e-02,7.420404907312636578e-01,4.729385929451246362e-01,4.324028591382429454e-01,2.463628100398747023e-01,5.136481049656353992e-01,9.821075796459962648e-01,4.674779570549221219e-01,1.913242983495060390e-01,8.740120169517850979e-01,2.939624845883279658e-01,3.717964154049030467e-01,7.859055981932769885e-01,6.796072769173525652e-01,5.182242700777538458e-01,5.224501184352001726e-01,2.444231737135459381e-01,6.448565860297961194e-01,7.661282368608102189e-01,3.902109052931768129e-01,4.769050331762979544e-01,7.035014529935912364e-01,9.008880316805597532e-01,3.221795281976428393e-01,9.064019402604074349e-01,6.746270990111535859e-02,9.922225228170167277e-02,2.937523370886759855e-01,3.305641275106010468e-01,2.675009896857543090e-01,6.283132545202902985e-01,1.580090372250784192e-01,5.791969321375785018e-01,4.306518151977536402e-01,1.245679196651384713e-01,1.344513126585190621e-01,2.538103712755077623e-01,7.360815821467205922e-01,5.091257697035398433e-01,4.977480481492376763e-01,2.874336636996918104e-01,9.729701132912331740e-01,3.487755351333164944e-01,2.073468817447426948e-01,1.930283067205511571e-01,3.637210282561097463e-01,4.588390371858243055e-01,2.928816256098623061e-01,3.449631709471544516e-01,1.095273556281723959e-01,7.877937322760607541e-01,4.387226797420292757e-01,8.395719639216525643e-01,5.948315172882293611e-01,1.296916104598911934e-01,8.734843001426008113e-01,5.573884821838632764e-01,4.445141780636628903e-01,1.300864923742885981e-01,4.494478225268319083e-01,7.664995251199590021e-01,4.662567058966846645e-01,6.062912071480556220e-01,2.199591405596341698e-01,6.041807947342847651e-02,3.307715864174923803e-01,1.151563426983405192e-01,9.495815683947188557e-01,2.617755863860826704e-02,5.904713014953990591e-01,8.954236412906997344e-01,9.305577266147088134e-01,7.666721740277917529e-01,4.595224292385713394e-01,5.177010317171225617e-01,7.752742602969494579e-01,1.509035668792605422e-01,9.161494321746241898e-01,3.638349752344085530e-01,4.826926655885177553e-02,2.068268659651184560e-02,5.590629104884342615e-01,1.674340006557974991e-01,8.763758744255857325e-01,4.270937870547542037e-02,2.070696474011691768e-01,9.121666497447001865e-01,7.779929690690313704e-01,4.915517283459530651e-01,4.258232508300431318e-01,2.244131929820699645e-01,6.205518045212211620e-01,9.662305697994750808e-01,2.927868225718676110e-01,3.890019661171751908e-01,7.464866535340416442e-01,6.545860206805649284e-01,7.648037106668899021e-01,5.212658276116252098e-01,2.421698202720270476e-01,7.559648756265213709e-02,4.168825559148769955e-02,2.018254864645118163e-01,9.846854958596970020e-01,5.885815551047227645e-01,6.259502805342258558e-01,3.986422116897975210e-01,2.993326387488335349e-01,4.109665241744053787e-03,5.776123705794373731e-01,5.260974624529576316e-01,5.916508710958410244e-01,3.897410883317506958e-01,6.367116711544584806e-01,1.337930972232618254e-01,7.571547122227636484e-01,5.019462961388055922e-01,2.033050112050940328e-01,5.930096024327330406e-01,2.345419713104868187e-01,3.736937954375829651e-02,8.790098127336856138e-01,2.199691893546457111e-01,2.021735452555959434e-01,6.454530740790008769e-01,3.080686999848996077e-01,1.638976406688693599e-01,9.281154954832204762e-02,2.493072278926367069e-01,7.124931561493516030e-01,2.520782271064969660e-01,6.291977346746072675e-01,1.347768818182436545e-01,4.224162400902427006e-01,7.866424602838784086e-01,4.205799847162441374e-01,7.065848272862247370e-01,9.454078762746426223e-01,3.566168541532450664e-01,5.420256787285910871e-01,8.184981157486792558e-01,1.799491600530555013e-01,8.583725594705293727e-01,9.800039212914007924e-01,4.626005643287182112e-01,9.737252506102446192e-01,7.758034228117949294e-01,5.982831081887974856e-01,2.350635679475299167e-01,6.365280360095050272e-01,9.459706147360913420e-01,9.957607175881399986e-01,7.201936147159191393e-01,9.981219278679319684e-01,4.722739988594124583e-01,6.227208950656569764e-01,4.203566863153447297e-01,2.728469361912422286e-01,9.384456664026792350e-01,6.393616699969144612e-01,2.355478072562582348e-01,5.981561689663058567e-01,6.918848242749555677e-01,2.057234787529604869e-01,2.294359621656398840e-01,1.476514822434338292e-02,7.747378580412429550e-01,9.205610552418569403e-01,5.982887227902873306e-01,9.193254938351810290e-01,8.973671317344872334e-01,7.505407492978479755e-01,2.638310605407058196e-01,5.370192364518466821e-01,1.713146867975849919e-01,1.949465068184197403e-01,8.762201991211926444e-02,2.990883319371206994e-02,1.382065197857714756e-01,9.620081668710245282e-02,8.159092759942316864e-01,5.995304005803822056e-01,1.803671218308059432e-01,2.725368752123463745e-01,7.450093987308548105e-02,1.321756587816853568e-01,6.423965008417581446e-01,6.805013335842696742e-01,9.393949607457993123e-01,4.117412391333119537e-02,5.770351621486770055e-01,9.473760978768978047e-01,5.890806280985831922e-01,1.219183508661587645e-01,5.239988706817574338e-01,3.351680389016890027e-01,4.693749946690983776e-01,4.350456691508454155e-01,5.030782122061183692e-01,5.307920765135576424e-01,8.964907047278949381e-01,5.006560239478198282e-01,3.986700731436495504e-01,7.172798352941023303e-01,4.979868217128572416e-01,2.945332637710915691e-01,4.420802630070785888e-02,4.427801051166353474e-01,3.270692790541763761e-01,4.624435307291159258e-01,1.324711813296038931e-01,1.834702211073042655e-01,5.570833102480432508e-01,3.398981639033219482e-01,4.817519700887105127e-01,3.865008829272846835e-01,4.192486773947584622e-01,3.284682140083939883e-01,7.881472637866595576e-01,6.696765181368748987e-01,6.616161065512793371e-01,5.756026648291875381e-01,7.934922680039379062e-01,3.892627312607799261e-02,7.587667959742968593e-01,8.380350843745882905e-01,8.534300274705608480e-02,1.416670981388901129e-02,3.749923003814441547e-01,9.252478832522312846e-01,1.506229046661380355e-01,9.048644975748471042e-01,8.648166043326255270e-01,7.529311146348046657e-01,2.896962731050557460e-01,1.797315069501511653e-01,8.070281559175475072e-01,7.525812276948228297e-01,7.481618114397373676e-01,8.509878677726654406e-01,5.131858198771708235e-01,4.412716402285580264e-01,4.727773201270664138e-01,4.733192556043345212e-01,8.701182739941256683e-01,2.642624326121496559e-01,1.957810233078918216e-01,7.727861062596974584e-01,4.218816393281699106e-03,7.421750060539676896e-01,6.119842342905356114e-01,7.258224874431842277e-01,7.749018329830072993e-01,1.776753311124615875e-01,7.997413001399341637e-01,4.728619958390546385e-01,6.174509536046219882e-01,3.479590773852118124e-01,3.442418943701528455e-01,1.586061436878664077e-01,7.795054549679175659e-01,1.712271759532650872e-01,5.220966786074788812e-01,9.025375237411239482e-01,2.276812658959774804e-01,9.109156278554976227e-01,9.525446262584991164e-01,6.709165458713395314e-01,4.865199151632517705e-01,3.694102591158889837e-01,4.403167180547939985e-01,6.444885077587640954e-01,1.110639556797335947e-01,4.132664129151886190e-01,7.267634256547379490e-01,2.379070404290577478e-01,6.742438281108323883e-01,8.251513892265877059e-01,7.264569405414611492e-02,1.513847218720641985e-01,4.472727114088611566e-01,2.576935581935946296e-03,1.192907416581906466e-01,5.687262639658421381e-01,8.696727796851488890e-03,9.908238675615783642e-01,3.799779491208029603e-01,8.178658618099666766e-01,3.815700031565602002e-01,5.236555664960353962e-01,7.633764192476995003e-01,1.459599403536087081e-01,8.288237653090607671e-01,5.193562591464965239e-01,2.920451663695211586e-01,8.859350746486358563e-01,4.595361369331437684e-01,2.588176399006685280e-01,8.230843993086730537e-01,8.503629209292179469e-01,2.049232254192756564e-01,3.097685841022207454e-01,7.115970221626355396e-02,3.696287451714597161e-02,5.111788223744176962e-01,7.765387537579295785e-01,7.648602500948875615e-01,6.329656590277987771e-01,6.595231874904508018e-01,5.092682377582558040e-02,5.401703034618755561e-01,1.095959396018527654e-01,6.476978935962738326e-01,7.671608082707646048e-01,9.182114387512804177e-01,5.062559447567734905e-01,2.246655248907020175e-01,8.128165172485449785e-01,2.210292828390600928e-01,5.152648922751433824e-01,8.872021544140088478e-01,7.722817792860844355e-01,7.993163783591101801e-01,2.584843001972433330e-01,6.599508190697628285e-01,2.838005156449718847e-03,9.943337857144480818e-01,5.930993994228073163e-02,1.371036507253240444e-01,9.549482995660030227e-01,1.748403919850939348e-01,3.505696140495911939e-01,9.509390635621775001e-01,1.308237442503930037e-01,2.995014853502451224e-01,7.203653774050612357e-01,7.243542141682495217e-01,9.748669789399163621e-01,2.851783740911544296e-01,3.129574691026015820e-02,9.288179468962819429e-01,2.973074258945456183e-01,5.472177865481000492e-01,2.519617174521570080e-01,1.198718515459262779e-02,2.704255521358189807e-02,4.463671065932807158e-01,4.544699332513981727e-01,1.090959770269916973e-01,1.375311102691666454e-01,3.092313661059880037e-01,1.735514614030292391e-01,4.209892908339364359e-01,6.195968563352257652e-01,9.985990028607780733e-01,8.318368953061222593e-01,9.660600574211608560e-02,2.468844190104743097e-01,4.721669199404475714e-01,2.678675709006319572e-01,9.623789679673325770e-01,6.675448231197396165e-01,4.189882930241414227e-01,5.310916282670241628e-02,8.984562702707532544e-02,1.840590127721133396e-01,5.712196512559775119e-02,8.731799417485106574e-01,4.917443587929400950e-01,5.939485680278642210e-01,5.509796895329648336e-01,4.599529933227493039e-01,9.957740561775254573e-01,8.718740872162089595e-02,4.869541222049093010e-01,9.772982015955625767e-01,1.159323920083469295e-01,2.640798851419626780e-01,8.096038247590846559e-01,1.173936030734897829e-01,5.438277089332455017e-02,7.578183850663688936e-02,5.422949479567334974e-01,8.659639877600506797e-01,4.382536074596586895e-01,8.817111053416749611e-01,7.445624767972546243e-01,7.486728341886026428e-01,8.230078008000154544e-01,3.558277153463450526e-01,3.669995774800376420e-01,8.736678488888459659e-01,2.495409900680517490e-01,4.201839656730083084e-01,8.683756910932695083e-01,2.455197261023538413e-01,7.204157532583798096e-01,3.440075071991780531e-01,9.520838861407427967e-01,3.408781050042275496e-01,5.251892771431909690e-01,1.739395074982751366e-01,6.604754766004428124e-02,1.201388872124531382e-02,8.617960138726550312e-01,5.506143473021662960e-01,5.951281013139733123e-01,5.434941847356515865e-01,1.403960356413946897e-01,1.156153624469336005e-02,6.566193502587441833e-01,2.245986952556840999e-01,3.843991482542972182e-01,3.695739422187108714e-01,2.408658348901120405e-01,4.246579926102534985e-01,6.046255759845003963e-01,6.042704792829923788e-01,9.593254193992132306e-01,8.309422578818912442e-01,3.864299824163508479e-01,8.287006179923770421e-01,8.384821344445857472e-01,3.414602203421853721e-01,3.482109375087184544e-01,4.736729530260260779e-01,8.640412228816161111e-01,7.053484982275928239e-01,8.614259561119664843e-01,2.743103433344172837e-01,2.892838965916368910e-01,4.949252329471660605e-01,2.433140404483161712e-01,8.464376600653958915e-01,7.940422240384334973e-01,8.265762565631622483e-01,8.913466138715334663e-01,8.272252387402935225e-01,9.859323494648656316e-01,9.893431021074761134e-03,6.003136900584573610e-01,3.872061384822450547e-01,5.750760244394286236e-01,3.465408237658400559e-01,6.787399910785070212e-01,8.465090072208854011e-01,5.253353072092326048e-02,8.797713903877653063e-01,9.828816815281810060e-01,9.352914828203278130e-01,1.159707551742840126e-01,9.812576429148170964e-01,5.979119829025445476e-01,5.045331027455018935e-01,2.455328470352013959e-02,3.756540658660064702e-01,4.723071377038084995e-01,7.320118009486309418e-02,6.624212501513014884e-01,9.097670964996754650e-01,1.417108930223807128e-01,4.671452764751611308e-01,5.165406199762700989e-01,4.539539910720228333e-01,7.092517175182907474e-01,7.131340111849707730e-01,4.508935351645022571e-01,5.692178340961826510e-01,1.110927062807093302e-01,5.489157717160381145e-01,7.573529252170236870e-01,4.949599155177067944e-01,2.450271288016745430e-01,1.106340877461642336e-01,9.451706083168471828e-01,4.406168843955566850e-01,8.508507308185562223e-01,9.773328888710413054e-01,8.055873058875505643e-01,7.412688991783389358e-01,1.345691638947499325e-02,3.208405823316693439e-01,1.205796963056027238e-01,6.574386043296187587e-01,7.840466531471212974e-01,4.691252092042160760e-01,4.512798532384100225e-01,2.535286396911229367e-01,2.158303344763919940e-01,8.494721253725567855e-01,9.031880475178852841e-01,3.952026843243974241e-01,2.921916865628230164e-01,2.208845117272548730e-01,2.854604899032753274e-02,6.625767596995039144e-01,4.998724390007313056e-01,5.079703387002778570e-01,5.382220177469320133e-01,6.282325846675000935e-01,2.402645939899419325e-01,5.533374650970812603e-03,5.696293145068328512e-01,3.393178918383714660e-01,3.867295553612931647e-01,5.258179611611226711e-01,6.910997654386417111e-01,9.250056503915130568e-01,2.132719341125273171e-01,3.706476749579956653e-01,5.888720008367825942e-01,6.573201361214320304e-01,4.466813017641506622e-01,6.981905398334182777e-01,5.799910268539462121e-01,4.021415286474785411e-01,8.959318949574768265e-02,8.209498966209928250e-01,6.130282449016354329e-01,1.084013768828929747e-01,2.964912708798909113e-01,1.256727962100421259e-01,9.093672902814001757e-01,6.002646761972344480e-01,1.998408625836537444e-01,2.524335176371121925e-01,3.765555861129507020e-01,5.878203655215631374e-01,4.662539346015702746e-01,4.292163218071265440e-01,2.619627444637265823e-01,7.338627711664307274e-01,3.401641759206571747e-01,6.730328005598589236e-01,2.849845661482869330e-01,4.050786059063521405e-01,2.021099378018174075e-01,5.447346878101135825e-01,7.306270132275125562e-01,9.392534166427313203e-01,5.287384729466579891e-01,2.342899864864969040e-01,1.372307812736990318e-01,3.087389380084151203e-01,4.085420445309068116e-01,2.462296513485284777e-02,4.293093117733003394e-01,2.196725738135700823e-01,3.266982831984635016e-01,2.913583537557531411e-01,7.387262706233437282e-01,3.747822129125017998e-01,3.305942553065105427e-01,4.986153276217070163e-01,6.513259253785059766e-01,9.847432194051570775e-01,4.961861973504777534e-02,4.185036386370921679e-02,7.269645950526332223e-01,9.768775691428885910e-01,6.272732450256501835e-04,8.592873013271510318e-01,1.962398474369881907e-01,1.226582388370152099e-01,3.817378197850873622e-02,9.255892715463559517e-01,1.151770359028615465e-01,5.827505561535148981e-01,6.970071064392783233e-01,2.746795420397573073e-01,1.368186859186992788e-01,8.164139771625615882e-01,5.365354798296876337e-01,8.298287440043946583e-01,4.512112410120833195e-01,8.033472637398577643e-01,4.097270513387064605e-01,4.836561142881797837e-01,4.652642153758768107e-02,6.170604945361449767e-01,8.651397132064980733e-01,7.106137167336352700e-01,2.815668887564171108e-02,2.198680065722034005e-01,7.446174474027860146e-01,9.156207111804364196e-01,2.120104140932436154e-01,2.474090360034917335e-01,5.021599145227910732e-01,6.598397479377831054e-01,9.060621131863516586e-01,6.133868925665205696e-01,7.496971701484639317e-01,2.387068215262252435e-01,2.155750416699353522e-01,8.389080244741854431e-01,2.709073854983011787e-01,8.977009536107850574e-01,5.669328982867765099e-01,8.146259525931627277e-01,1.405330391473905705e-01,2.420700675192519746e-01,9.440988631522490016e-01,7.538803212669826781e-01,7.675319918553279441e-01,2.796949867687918978e-01,6.450779869013114620e-01,7.221124657110192802e-01,9.371206968261232007e-01,3.183780712887898101e-01,9.153536149907507413e-01,8.638290843471212455e-01,5.129597632385346495e-01,1.622417034949765746e-01,1.147564166481682690e-01,6.111121805040595767e-01,3.611143632112598922e-01,6.209082850557285926e-01,7.332793418557419507e-01,4.586984338902406755e-01,5.804606363294089189e-01,8.934466056258629774e-01,2.957962028087289807e-01,8.894944088185093856e-01,9.834952676513637471e-01,2.110791841981742856e-01,4.260207675719230869e-01,2.803811558870258347e-01,7.577813157854451642e-01,5.952303626524743096e-01,8.103076032491698388e-01,5.616009388507362532e-01,1.819714192757506677e-01,6.840674294552440138e-01,1.568580684028325622e-01,9.442951757893458531e-01,8.016387075182845878e-01,5.201296968533354326e-01,4.958590895819030564e-01,9.083054220800649281e-01,3.968003917659854718e-01,8.555907096864938666e-01,1.361172901046814321e-01,6.548378061380952797e-01,7.024744750769248425e-01,2.686427438174876503e-01,9.791088789634921907e-01,8.492897305430628929e-01,1.101282015284923421e-01,4.901520116149515882e-01,1.684553615333179710e-01,5.266383918316315249e-01,2.233177417719722779e-02,1.056364414484497471e-01,9.183250439288370703e-02,3.769052032090606241e-01,8.080673488220644352e-01,2.045429588986081848e-01,2.042588409481305156e-02,6.965142126626344687e-02,6.526949154805836706e-01,1.345363021230711054e-01,5.394558259084867302e-01,5.758145829873908550e-01,2.639941368953416800e-01,5.282150436783192848e-01,7.263107089841167596e-01,5.210747653358727138e-01,3.431944629047894990e-01,5.123589979347709100e-02,9.896142029491986625e-01,8.981950938077090107e-01,6.214699585444696250e-01,2.754195131158484466e-01,1.089894816369396668e-02,1.854218108278334887e-01,7.762975538780045870e-01,1.631245131499137191e-01,6.265005838774060365e-01,1.145509017695833798e-02,9.185098855283476693e-01,1.578987652368805117e-01,2.694179836463811428e-01,6.454527767645463765e-01,7.648283197952084889e-01,6.348922372663559077e-01,3.109374614666794434e-01,5.423801818908375871e-01,2.758117609542892756e-01,2.290512203974959249e-01,7.391519436857827419e-01,6.007177838193933361e-01,2.265337299292812245e-01,2.422683487851118311e-01,8.375445526304959865e-01,5.762100589824172836e-01,6.305805692048993549e-01,6.406428667109006492e-01,3.936685715860325230e-01,1.720118074589898072e-01,6.380086745359853095e-01,8.162990136951718823e-01,3.195649479089972544e-01,4.885895692286094105e-01,9.030436008581459451e-01,5.237362757468737584e-01,1.189100392597510769e-01,9.587949359972137708e-01,2.675392471996682620e-01,7.019284956275493315e-01,6.651270445605970139e-01,8.516279099102594952e-01,4.412301451873579250e-01,4.981500961502669522e-01,2.240491918976591501e-01,3.974233435190805963e-01,3.572991416925743735e-01,4.324845343282945898e-01,4.032160498071221122e-01,1.780608144762854117e-01,7.979217394299245036e-01,3.611678412730499055e-01,4.509767655348034809e-01,4.168912410034688598e-01,6.833955598989487346e-01,6.859169987373798794e-01,1.141848508839337084e-01,9.106529082602425884e-01,9.947374027329468626e-01,9.551695889240530146e-01,3.535731890339388617e-01,3.938876177951378121e-02,7.546820054384129062e-02,7.923187476474520263e-01,1.065615063842243471e-01,7.662176602152170890e-01,4.817688046309549499e-01,1.266321248774471275e-02,3.274946786313099878e-01,2.408155698509970577e-01,6.200659412744831123e-01,8.303842117599560257e-01,4.860919323449842677e-01,8.867446062736378254e-01,5.663932416816158666e-01,2.588562954746402855e-01,8.620718486947336334e-01,3.040361594252025679e-01,5.393191895378763867e-01,8.495418910378285116e-01,1.597991124538234997e-01,2.322976454089276110e-02,6.816006807859816830e-01,3.025499834070084493e-01,2.852032779395363704e-02,5.167535360611371642e-01,9.363348884817052076e-01,6.388680997406772644e-01,1.990064256971553203e-01,1.544153752000489987e-01,4.872294906067036191e-01,5.147455492836811031e-01};


#define FPU_EXCEPTION_MASK   0x0000009F //!< FPU exception mask used to clear exceptions in FPSCR register.

#define SCL   NRF_GPIO_PIN_MAP(1, 10)       //clock line
#define SDA   NRF_GPIO_PIN_MAP(1, 11)       //data line
#define INT1  NRF_GPIO_PIN_MAP(1, 12)      //for interrupts
#define INT2  NRF_GPIO_PIN_MAP(1, 13)      //for interuppts

static const nrfx_twim_t twim = NRFX_TWIM_INSTANCE(0);

#define ADDRESS 0x6B // TWI address of sensor

/* Variables used for accessing the acceleration data */
static axis3bit16_t data_raw_acceleration;
static float acceleration_mg[3];
static uint8_t rst;

#define MAX_SIZE            512
#define MAX_SIZE_HALF       512/2
#define WIN_SIZE            227
#define FREQ                26
#define BUFFER_SIZE         512
#define NUM_OF_ACC_WINDOWS  4 //when only acc is read we need to split the fifo in smaller windows
#define ACC_WINDOW          MAX_SIZE/NUM_OF_ACC_WINDOWS //size of the split acc window
/*
 *Accelorometer buffers are bigger at the start because we make the fifo buffer 512 elements long
 *and it reads only the acc data
 */
volatile float32_t acc_X[MAX_SIZE];
volatile float32_t acc_Y[MAX_SIZE];
volatile float32_t acc_Z[MAX_SIZE];

volatile float32_t acc_X_filtered[MAX_SIZE];
volatile float32_t acc_Y_filtered[MAX_SIZE];
volatile float32_t acc_Z_filtered[MAX_SIZE];

//gyro data
volatile float32_t gyr_X[MAX_SIZE_HALF];
volatile float32_t gyr_Y[MAX_SIZE_HALF];
volatile float32_t gyr_Z[MAX_SIZE_HALF];

volatile float32_t gyr_X_filtered[MAX_SIZE];
volatile float32_t gyr_Y_filtered[MAX_SIZE];
volatile float32_t gyr_Z_filtered[MAX_SIZE];

float32_t acc_X_buffer[BUFFER_SIZE];
float32_t acc_Y_buffer[BUFFER_SIZE];
float32_t acc_Z_buffer[BUFFER_SIZE];

float32_t gyr_X_buffer[BUFFER_SIZE];
float32_t gyr_Y_buffer[BUFFER_SIZE];
float32_t gyr_Z_buffer[BUFFER_SIZE];


lsm6dsl_ctx_t dev_ctx;

static int32_t platform_write(void *handle, uint8_t reg, uint8_t *buffer, uint16_t len)
{

    uint8_t tx_data[len + 1];
    tx_data[0] = reg;
    memcpy(&tx_data[1], buffer, len);
    return nrfx_twim_tx(&twim, ADDRESS, tx_data, sizeof(tx_data), false);

}

static int32_t platform_read(void *handle, uint8_t reg, uint8_t *buffer, uint16_t len) {

    uint8_t tx_data[1] = {reg};
    ret_code_t err = nrfx_twim_tx(&twim, ADDRESS, tx_data, sizeof(tx_data), true);
    if (err != NRFX_SUCCESS)
        return err;
    return nrfx_twim_rx(&twim, ADDRESS, buffer, len);

}

//function for accelorometer reading
uint8_t read_accelerometer()
{
    uint16_t patt;
    uint8_t buffer;
    static uint16_t buffer_position = 0;
    float value_x;
    float value_y;
    float value_z;

    static axis3bit16_t data_raw_acceleration;
    

    for(uint16_t i = 0; i < MAX_SIZE; i++)
    {
        //acc code
        memset(data_raw_acceleration.u8bit, 0x00, 1*sizeof(int16_t));
        lsm6dsl_fifo_raw_data_get(&dev_ctx, data_raw_acceleration.i16bit, (unsigned int)2);
        value_x = lsm6dsl_from_fs2g_to_mg( data_raw_acceleration.i16bit[0]);
        acc_X[i] = value_x/1000;

       // NRF_LOG_INFO( NRF_LOG_FLOAT_MARKER , NRF_LOG_FLOAT(acc_X[i]/1000));
        memset(data_raw_acceleration.u8bit, 0x00, 1*sizeof(int16_t));
        lsm6dsl_fifo_raw_data_get(&dev_ctx, data_raw_acceleration.i16bit, (unsigned int)2);
        value_y = lsm6dsl_from_fs2g_to_mg( data_raw_acceleration.i16bit[0]);
        acc_Y[i] = value_y/1000;

     //   NRF_LOG_INFO( NRF_LOG_FLOAT_MARKER , NRF_LOG_FLOAT(acc_Y[i]));
        memset(data_raw_acceleration.u8bit, 0x00, 1*sizeof(int16_t));
        lsm6dsl_fifo_raw_data_get(&dev_ctx, data_raw_acceleration.i16bit, (unsigned int)2);
        value_z = lsm6dsl_from_fs2g_to_mg( data_raw_acceleration.i16bit[0]);
        acc_Z[i] = value_z/1000;

      // NRF_LOG_INFO( NRF_LOG_FLOAT_MARKER , NRF_LOG_FLOAT(acc_Z[i]));  
    
    }

    //check if you really need to ignore first 149 samples
    /*
    filter_data(acc_X,MAX_SIZE_HALF,acc_X_filtered,FILTER_LOWPASS);
    filter_data(acc_Y,MAX_SIZE_HALF,acc_Y_filtered,FILTER_LOWPASS);
    filter_data(acc_Z,MAX_SIZE_HALF,acc_Z_filtered,FILTER_LOWPASS);
    */
    for(int i = 0; i < MAX_SIZE ;i++)
    {
      //store values in acc_N_buffer to make windows that are 512 elements long
      acc_X_buffer[buffer_position] = acc_X[i];
      acc_Y_buffer[buffer_position] = acc_Y[i];
      acc_Z_buffer[buffer_position] = acc_Z[i];
      
      buffer_position++; //

      printf("%f,%f,%f,%f,%f,%f\n",acc_X[i],acc_Y[i],acc_Z[i],gyr_X[i],gyr_Y[i],gyr_Z[i]);    // printf("%f,%f,%f,%f,%f,%f\n",acc_X[i],acc_Y[i],acc_Z[i],gyr_X[i],gyr_Y[i],gyr_Z[i]);
      nrf_delay_ms(5);
      if(buffer_position >= BUFFER_SIZE){ buffer_position = 0; return 1;}  //reset the buffer and returns "1" as a sign that the buffer is full
    }
    return 0;
    
}
uint8_t read_accelerometer_gyroscope()
{   


    uint16_t patt;
    uint8_t buffer;

    static uint16_t buffer_position = 0;

    float32_t value_x;
    float32_t value_y;
    float32_t value_z;

    float32_t gyr_value_x;
    float32_t gyr_value_y;
    float32_t gyr_value_z;

    static axis3bit16_t data_raw_acceleration;
    static axis3bit16_t data_raw_gyroscope;
    for(int i = 0; i < MAX_SIZE/2; i++)
    {

        /* Check the pattern to see what comes next in the FIFO*/
        /*lsm6dsl_fifo_pattern_get(&dev_ctx, &patt);
        printf("Next sample in FIFO - pattern %u\n", (unsigned int)patt);*/
        
        //gyro code
        memset(data_raw_gyroscope.u8bit, 0x00, 1*sizeof(int16_t));
        lsm6dsl_fifo_raw_data_get(&dev_ctx, data_raw_gyroscope.i16bit, (unsigned int)2);
        gyr_value_x = lsm6dsl_from_fs250dps_to_mdps( data_raw_gyroscope.i16bit[0]);
        gyr_X[i] = gyr_value_x/1000;
       // NRF_LOG_INFO( NRF_LOG_FLOAT_MARKER , NRF_LOG_FLOAT(acc_X[i]/1000));
        memset(data_raw_gyroscope.u8bit, 0x00, 1*sizeof(int16_t));
        lsm6dsl_fifo_raw_data_get(&dev_ctx, data_raw_gyroscope.i16bit, (unsigned int)2);
        gyr_value_y = lsm6dsl_from_fs250dps_to_mdps( data_raw_gyroscope.i16bit[0]);
        gyr_Y[i] = gyr_value_y/1000;
     //   NRF_LOG_INFO( NRF_LOG_FLOAT_MARKER , NRF_LOG_FLOAT(acc_Y[i]));
        memset(data_raw_gyroscope.u8bit, 0x00, 1*sizeof(int16_t));
        lsm6dsl_fifo_raw_data_get(&dev_ctx, data_raw_gyroscope.i16bit, (unsigned int)2);
        gyr_value_z = lsm6dsl_from_fs250dps_to_mdps( data_raw_gyroscope.i16bit[0]);
        gyr_Z[i] = gyr_value_z/1000;
        
        //acc code
        memset(data_raw_acceleration.u8bit, 0x00, 1*sizeof(int16_t));
        lsm6dsl_fifo_raw_data_get(&dev_ctx, data_raw_acceleration.i16bit, (unsigned int)2);
        value_x = lsm6dsl_from_fs2g_to_mg( data_raw_acceleration.i16bit[0]);
        acc_X[i] = value_x/1000;

       // NRF_LOG_INFO( NRF_LOG_FLOAT_MARKER , NRF_LOG_FLOAT(acc_X[i]/1000));
        memset(data_raw_acceleration.u8bit, 0x00, 1*sizeof(int16_t));
        lsm6dsl_fifo_raw_data_get(&dev_ctx, data_raw_acceleration.i16bit, (unsigned int)2);
        value_y = lsm6dsl_from_fs2g_to_mg( data_raw_acceleration.i16bit[0]);
        acc_Y[i] = value_y/1000;

     //   NRF_LOG_INFO( NRF_LOG_FLOAT_MARKER , NRF_LOG_FLOAT(acc_Y[i]));
        memset(data_raw_acceleration.u8bit, 0x00, 1*sizeof(int16_t));
        lsm6dsl_fifo_raw_data_get(&dev_ctx, data_raw_acceleration.i16bit, (unsigned int)2);
        value_z = lsm6dsl_from_fs2g_to_mg( data_raw_acceleration.i16bit[0]);
        acc_Z[i] = value_z/1000;

      // NRF_LOG_INFO( NRF_LOG_FLOAT_MARKER , NRF_LOG_FLOAT(acc_Z[i]));  
      
    }
    /*filter_data(gyr_X,MAX_SIZE_HALF,gyr_X_filtered,FILTER_LOWPASS);
    filter_data(gyr_Y,MAX_SIZE_HALF,gyr_Y_filtered,FILTER_LOWPASS);
    filter_data(gyr_Z,MAX_SIZE_HALF,gyr_Z_filtered,FILTER_LOWPASS);

    filter_data(acc_X,MAX_SIZE_HALF,acc_X_filtered,FILTER_LOWPASS);
    filter_data(acc_Y,MAX_SIZE_HALF,acc_Y_filtered,FILTER_LOWPASS);
    filter_data(acc_Z,MAX_SIZE_HALF,acc_Z_filtered,FILTER_LOWPASS);
    */

    for(int i = 0; i < MAX_SIZE_HALF;i++)
    {
      //store values in acc_N_buffer to make windows that are 512 elements long
      acc_X_buffer[buffer_position] = acc_X[i];
      acc_Y_buffer[buffer_position] = acc_Y[i];
      acc_Z_buffer[buffer_position] = acc_Z[i];
      
      //store values in gyr_N_buffer to make windows that are 512 elements long
      gyr_X_buffer[buffer_position] = gyr_X[i];
      gyr_Y_buffer[buffer_position] = gyr_Y[i];
      gyr_Z_buffer[buffer_position] = gyr_Z[i];
      
      buffer_position++;

      printf("%f,%f,%f,%f,%f,%f\n",acc_X[i],acc_Y[i],acc_Z[i],gyr_X[i],gyr_Y[i],gyr_Z[i]);  // 
      nrf_delay_ms(5);

      if(buffer_position >= BUFFER_SIZE){ buffer_position = 0; return 1;}  //reset the buffer and returns "1" as a sign that the buffer is full

    }
    return  0;
}



void fifo_full()
{

    #define STATE_READ_ACC      0
    #define STATE_READ_ACC_GYR  1
    static uint8_t state = STATE_READ_ACC;
    uint8_t result;

    //state machine used for reading only accelarometer or acc and gyro
    //look at threshold_logic.c for functions
    switch(state)
    {
      case STATE_READ_ACC:
            if(read_accelerometer()) //if the acc_N_buffer array is full the function returns "1" and we check the threshold
            {
            /* Since the fifo buffer needs to be split in smaller frames a for loop is used to do that 
             * and at the same time it checks the windows.
             * NUM_OF_ACC_WINDOWS holds the amount of windows
             * In the start_thereshold function we increment the acc array pointer by the size of the window
             * If enough frames are above the threshold the loop breaks and it switches to reading acc and gyro
             */
              for(uint8_t i = 0; i < NUM_OF_ACC_WINDOWS; i++){
              printf("in read acc fun i = %d",i);
                if(start_threshold((acc_Y + i*ACC_WINDOW), (acc_Y + i*ACC_WINDOW),ACC_WINDOW))
                {
                  state = STATE_READ_ACC_GYR;
                  break;
                }
                
              
              }
            }
            //printf("STATE_READ_ACC\n");
         state = STATE_READ_ACC_GYR;
          
      break;
      case STATE_READ_ACC_GYR:
            
            if(read_accelerometer_gyroscope()) //if the acc_N_buffer, gyr_N_buffer array are full the function returns "1" and we check the threshold
            { 
              result = proceed_threshold(acc_Y_buffer,acc_Z_buffer,MAX_SIZE);
              if(result == STOP)
              {
                state = STATE_READ_ACC;
              }
            }
        
      break;
    
    
    }

      //FIFO data is stored in acc arrays, FIFO can be reset and restart
      
      if(state == STATE_READ_ACC_GYR)
      {
         lsm6dsl_fifo_mode_set(&dev_ctx, LSM6DSL_BYPASS_MODE);   //resets buffer
         //Set Output Data Rate and full scale for acc
         lsm6dsl_xl_data_rate_set(&dev_ctx, LSM6DSL_XL_ODR_52Hz);
         lsm6dsl_xl_full_scale_set(&dev_ctx, LSM6DSL_2g);

         //Set Output Data Rate and full scale for gyro
         lsm6dsl_gy_data_rate_set(&dev_ctx, LSM6DSL_XL_ODR_52Hz);
         lsm6dsl_gy_full_scale_set(&dev_ctx, LSM6DSL_250dps);
         lsm6dsl_fifo_data_rate_set(&dev_ctx, LSM6DSL_FIFO_52Hz);

         //enable FTH(fifo stops at selected number of bytes(resolution is 2 bytes))
         lsm6dsl_fifo_stop_on_wtm_set(&dev_ctx,1);
         //set watermark level
         lsm6dsl_fifo_watermark_set(&dev_ctx,3*MAX_SIZE+3);         
         
         //Decimation - data to be stored in FIFO
         lsm6dsl_fifo_gy_batch_set(&dev_ctx, LSM6DSL_FIFO_GY_NO_DEC);
         lsm6dsl_fifo_xl_batch_set(&dev_ctx, LSM6DSL_FIFO_XL_NO_DEC);
       
         lsm6dsl_fifo_mode_set(&dev_ctx, LSM6DSL_FIFO_MODE);//buffer starts
    
      }
      if(state == STATE_READ_ACC)
      {
         lsm6dsl_fifo_mode_set(&dev_ctx, LSM6DSL_BYPASS_MODE);   //resets buffer
          //Set Output Data Rate and full scale for gyro
         lsm6dsl_gy_data_rate_set(&dev_ctx, LSM6DSL_GY_ODR_OFF);
         //Set Output Data Rate and full scale for acc
         lsm6dsl_xl_data_rate_set(&dev_ctx, LSM6DSL_XL_ODR_52Hz);
         lsm6dsl_xl_full_scale_set(&dev_ctx, LSM6DSL_2g);
         lsm6dsl_fifo_data_rate_set(&dev_ctx, LSM6DSL_FIFO_52Hz);  
        
         //lsm6dsl_gy_full_scale_set(&dev_ctx, LSM6DSL_8g);

         //enable FTH(fifo stops at selected number of bytes(resolution is 2 bytes))
         lsm6dsl_fifo_stop_on_wtm_set(&dev_ctx,1);
         //set watermark level
         lsm6dsl_fifo_watermark_set(&dev_ctx,3*MAX_SIZE+3);
         
         //Decimation - data to be stored in FIFO
         lsm6dsl_fifo_gy_batch_set(&dev_ctx, LSM6DSL_FIFO_GY_DISABLE);
         lsm6dsl_fifo_xl_batch_set(&dev_ctx, LSM6DSL_FIFO_XL_NO_DEC);

         lsm6dsl_fifo_mode_set(&dev_ctx, LSM6DSL_FIFO_MODE);//buffer starts
      }
      

      memset(gyr_X, 0.0f, MAX_SIZE_HALF*sizeof(float32_t));
      memset(gyr_Y, 0.0f, MAX_SIZE_HALF*sizeof(float32_t));
      memset(gyr_Z, 0.0f, MAX_SIZE_HALF*sizeof(float32_t));

      memset(gyr_X_buffer, 0.0f, MAX_SIZE*sizeof(float32_t));
      memset(gyr_Y_buffer, 0.0f, MAX_SIZE*sizeof(float32_t));
      memset(gyr_Z_buffer, 0.0f, MAX_SIZE*sizeof(float32_t));

      memset(acc_X, 0.0f, MAX_SIZE_HALF*sizeof(float32_t));
      memset(acc_Y, 0.0f, MAX_SIZE_HALF*sizeof(float32_t));
      memset(acc_Z, 0.0f, MAX_SIZE_HALF*sizeof(float32_t));

      memset(acc_X_filtered, 0.0f, MAX_SIZE*sizeof(float32_t));
      memset(acc_Y_filtered, 0.0f, MAX_SIZE*sizeof(float32_t));
      memset(acc_Z_filtered, 0.0f, MAX_SIZE*sizeof(float32_t));
      /* Clear FPSCR register and clear pending FPU interrupts. This code is base on
       * nRF5x_release_notes.txt in documentation folder. It is necessary part of code when
       * application using power saving mode and after handling FPU errors in polling mode.
       */
        __set_FPSCR(__get_FPSCR() & ~(FPU_EXCEPTION_MASK));
        (void) __get_FPSCR();
        NVIC_ClearPendingIRQ(FPU_IRQn);

}

void int2_handler(nrf_drv_gpiote_pin_t pin, nrf_gpiote_polarity_t action)
{
    
    bsp_board_led_invert(1);//DELETE THIS (was used on SDK for debugging)
    fifo_full();

}
int main()
{
    bsp_board_init(BSP_INIT_LEDS);
    uart_init();
    //Interrupt initialization version 2 (GPIO)
    ret_code_t err_code;

    err_code = nrf_drv_gpiote_init();
    APP_ERROR_CHECK(err_code);

    nrf_drv_gpiote_in_config_t in_config = GPIOTE_CONFIG_IN_SENSE_TOGGLE(true);
    in_config.pull = NRF_GPIO_PIN_PULLUP;
    in_config.sense = GPIOTE_CONFIG_POLARITY_LoToHi;

    //INT1 - *step detection*
    //err_code = nrf_drv_gpiote_in_init(INT1, &in_config, int2_handler);
    APP_ERROR_CHECK(err_code);
   // nrf_drv_gpiote_in_event_enable(INT1, true);


    //INT2 - *FULL_FIFO*
    err_code = nrf_drv_gpiote_in_init(INT2, &in_config, int2_handler);
    APP_ERROR_CHECK(err_code);
    nrf_drv_gpiote_in_event_enable(INT2, true);

    //init TWI
    nrfx_twim_config_t config = {
        .scl = SCL,
        .sda = SDA,
        .frequency = NRF_TWIM_FREQ_100K,
        .interrupt_priority = APP_IRQ_PRIORITY_HIGH,
    };
    APP_ERROR_CHECK(nrfx_twim_init(&twim, &config, NULL, NULL));
    nrfx_twim_enable(&twim);

    // LSM6DSL init
    dev_ctx.write_reg = platform_write; //mandatory field
    dev_ctx.read_reg = platform_read;   //mandatory field

    uint8_t whoamI = 0;
    lsm6dsl_device_id_get(&dev_ctx, &whoamI);
    // NRF_LOG_INFO("TWI address 0x%x", whoamI);
    //Restore default configuration
    lsm6dsl_reset_set(&dev_ctx, PROPERTY_ENABLE);
    do {
      lsm6dsl_reset_get(&dev_ctx, &rst);
    } while (rst);

     //INTERRUPT 2
     lsm6dsl_int2_route_t int2_route;
     int2_route.int2_drdy_xl = PROPERTY_DISABLE;
     int2_route.int2_full_flag =  PROPERTY_ENABLE;
     int2_route.int2_drdy_g = PROPERTY_DISABLE;
     int2_route.int2_drdy_temp = PROPERTY_DISABLE;
     int2_route.int2_fth = PROPERTY_DISABLE;
     int2_route.int2_fifo_ovr = PROPERTY_DISABLE;
     int2_route.int2_step_count_ov = PROPERTY_DISABLE;
     int2_route.int2_step_delta = PROPERTY_DISABLE;
     int2_route.int2_iron = PROPERTY_DISABLE;
     int2_route.int2_tilt = PROPERTY_DISABLE;
     int2_route.int2_6d = PROPERTY_DISABLE;
     int2_route.int2_double_tap = PROPERTY_DISABLE;
     int2_route.int2_ff = PROPERTY_DISABLE;
     int2_route.int2_wu = PROPERTY_DISABLE;
     int2_route.int2_single_tap = PROPERTY_DISABLE;
     int2_route.int2_double_tap = PROPERTY_DISABLE;
     int2_route.int2_inact_state = PROPERTY_DISABLE;
     int2_route.int2_wrist_tilt = PROPERTY_DISABLE;
     lsm6dsl_pin_int2_route_set(&dev_ctx, int2_route);
      
     /* Accelerometer - LPF1 path ( LPF2 not used )*/
     //lsm6dsl_xl_lp1_bandwidth_set(&dev_ctx, LSM6DSL_XL_LP1_ODR_DIV_4);

     /* Accelerometer - LPF1 + LPF2 path */
     lsm6dsl_xl_lp2_bandwidth_set(&dev_ctx, LSM6DSL_XL_LOW_LAT_LP_ODR_DIV_100);

     /* Gyroscope - filtering chain */
     lsm6dsl_gy_band_pass_set(&dev_ctx, LSM6DSL_HP_260mHz_LP1_STRONG);
     lsm6dsl_gy_band_pass_set(&dev_ctx, LSM6DSL_HP_16mHz_LP2);

  
     //Enable Block Data Update
     lsm6dsl_block_data_update_set(&dev_ctx, PROPERTY_ENABLE);
     lsm6dsl_auto_increment_set(&dev_ctx, PROPERTY_ENABLE);
     
     //Set Output Data Rate and full scale for acc
     lsm6dsl_xl_data_rate_set(&dev_ctx, LSM6DSL_XL_ODR_52Hz);
     lsm6dsl_xl_full_scale_set(&dev_ctx, LSM6DSL_2g);

     //Set FIFO trigger - acc data ready signal
     lsm6dsl_fifo_write_trigger_set(&dev_ctx, LSM6DSL_TRG_XL_GY_DRDY);
     
     //set watermark level
     lsm6dsl_fifo_watermark_set(&dev_ctx,3*MAX_SIZE+3);

     //enable FTH(fifo stops at selected number of bytes(resolution is 2 bytes))
     lsm6dsl_fifo_stop_on_wtm_set(&dev_ctx,1);
     
     //Decimation - data to be stored in FIFO
     lsm6dsl_fifo_xl_batch_set(&dev_ctx, LSM6DSL_FIFO_GY_NO_DEC);
     lsm6dsl_fifo_dataset_3_batch_set(&dev_ctx, LSM6DSL_FIFO_DS3_DISABLE);
     lsm6dsl_fifo_dataset_4_batch_set(&dev_ctx, LSM6DSL_FIFO_DS4_DISABLE);

     //FIFO data rate and mode
     lsm6dsl_fifo_data_rate_set(&dev_ctx, LSM6DSL_FIFO_52Hz);
     lsm6dsl_fifo_mode_set(&dev_ctx, LSM6DSL_FIFO_MODE);
    
     float32_t features[36];
    // CF_fill_features_arr(features,testInput);
     //printf("Eating = %d",predict(features,36));



  while(1)
  {
   
    bsp_board_led_invert(3);
    nrf_delay_ms(1000);
  

  }
}
